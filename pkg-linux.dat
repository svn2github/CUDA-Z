#!/bin/sh
#set -x
echo "$czNameShort $czVersion Container"
errMsgWrong="Wrong OS! This is a linux i686/x86_64 package."
errMsgSum="Wrong md5 sum of"
osName=`uname -o`; if test x"$osName" != x"GNU/Linux"; then echo "$errMsgWrong"; exit 1; fi
osArch=`uname -m`; case "$osArch" in
i?86|x86_64) ;;
*) echo "$errMsgWrong"; exit 1 ;;
esac
tmpDir=/tmp
randID=`head -c8 /dev/random | od -x | head -n1 | sed -e "s/^[0-9]* //g" | tr " " -`
outDir=$tmpDir/$czNameShort-$randID
mkdir $outDir; sync; sleep 1
if test $? != 0; then echo "Cannot create temp directory."; exit 1; fi
case "$czPackSuffix" in
gz) czUnPack="gzip -dc" ;;
bz2) czUnPack="bzip2 -dc" ;;
*) echo "Unknown packer suffix!"; exit 1
esac
czAllSize=$(echo "$czExeSize + $czDllSize" | bc -l)
tail -c$czAllSize $0 | head -c$czExeSize | $czUnPack > $outDir/$czExeName
czExeSumNew=`md5sum $outDir/$czExeName | sed -e "s/ .*$//"`
if test x"$czExeSum" != x"$czExeSumNew"; then echo "$errMsgSum $czExeName!"; exit 1; fi
tail -c$czDllSize $0 | $czUnPack > $outDir/$czDllName
czDllSumNew=`md5sum $outDir/$czDllName | sed -e "s/ .*$//"`
if test x"$czDllSum" != x"$czDllSumNew"; then echo "$errMsgSum $czDllName!"; exit 1; fi
chmod +x $outDir/$czExeName $outDir/$czDllName
echo "Starting CUDA-Z..."
LD_LIBRARY_PATH=$outDir:$LD_LIBRARY_PATH $outDir/$czExeName
rm -Rf $outDir
exit 0
